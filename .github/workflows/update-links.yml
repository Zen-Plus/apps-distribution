name: Update static APK links after release

on:
  release:
    types: [published]

jobs:
  update-static-links:
    runs-on: ubuntu-latest

    steps:
      - name: Parse release tag to get app and version
        id: parse
        run: |
          tag=${{ github.event.release.tag_name }}
          version=$(echo "$tag" | sed 's/.*_v//')
          app_key=$(echo "$tag" | sed 's/_v.*//')
          echo "app_key=$app_key" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Checkout gh-pages branch
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git clone --branch gh-pages https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }} dist

      - name: Update download.html and regenerate index.html
        run: |
          APP_KEY="${{ steps.parse.outputs.app_key }}"
          VERSION="${{ steps.parse.outputs.version }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/app-release.apk"
          APP_DIR="dist/driver_mobile_app_${APP_KEY}"

          mkdir -p "$APP_DIR"

          # Create/Update download.html
          echo "<!DOCTYPE html><html><head><meta http-equiv='refresh' content='0;url=${RELEASE_URL}'></head><body>If not redirected, <a href='${RELEASE_URL}'>click here</a>.</body></html>" > "$APP_DIR/download.html"

          # Generate index.html listing all apps
          echo "<!DOCTYPE html><html><head><title>App Downloads</title></head><body><h1>Available Apps</h1><ul>" > dist/index.html

          for folder in dist/driver_mobile_app_*; do
            app_name=$(basename "$folder")
            echo "<li><a href='${app_name}/download.html'>${app_name}</a></li>" >> dist/index.html
          done

          echo "</ul></body></html>" >> dist/index.html

      - name: Commit and push changes
        run: |
          cd dist
          git add .
          git commit -m "Update ${{ steps.parse.outputs.app_key }} to v${{ steps.parse.outputs.version }}" || echo "No changes to commit"
          git push origin gh-pages
